<html>

<head>
<title>LD31</title>

<link rel="stylesheet" href="style.css" type="text/css" />

<!-- Included 3rd party libraries -->
<script type="text/javascript" src="libraries/jsbox2d.js"></script>

<!-- Render and Game code in here -->

<script type="text/javascript" src="misc.js"></script>
<script type="text/javascript" src="sounds.js"></script>
<script type="text/javascript" src="renderer.js"></script>
<script type="text/javascript" src="tile.js"></script>
<script type="text/javascript" src="entity.js"></script>
<script type="text/javascript" src="world.js"></script>
<script type="text/javascript" src="game.js"></script>



<script type="text/javascript">

//// Contains the main wrapper functions to interact with HTML5, and Init functions

//gloabal refs
var renderer;
var canvas;
var last_time; // timestamp of last frame to calculate delta

var game;

var sound;

function Init()
{
	canvas = document.getElementById("canvas");
	renderer = new Renderer(32*32, 32*20, canvas);

	document.getElementById("loading").style.display = "none";


	var tileimg = document.getElementById("tiles");
	var entimg = tileimg;

	game = new Game(renderer, tileimg, entimg);

	sound = new SoundManager();

	document.addEventListener('keydown', Game_KeyDown, true);
	document.addEventListener('keyup', Game_KeyUp, true);
	//canvas.addEventListener('click', Game_MouseClick, true);

	canvas.addEventListener('mousedown', Game_MouseDown, true);
	canvas.addEventListener('mouseup', Game_MouseUp, true);

	canvas.addEventListener('contextmenu', StopEvent, true);

	requestAnimationFrame(Step);
}


function Game_KeyDown(e)
{
	var char = String.fromCharCode(e.keyCode || e.charCode);
	game.Key(e, char, true);

	//return StopEvent(e);
}


function Game_KeyUp(e)
{
	var char = String.fromCharCode(e.keyCode || e.charCode);
	game.Key(e, char, false);

	return StopEvent(e);
}

function Game_MouseClick(e)
{
	game.Click(e.offsetX, e.offsetY);

	return StopEvent(e);
}


function Game_MouseDown(e)
{
	//Because nothing is simple and works across all browsers.. ugh
	var rect = canvas.getBoundingClientRect();
	var x = e.clientX - rect.left;
	var y = e.clientY - rect.top;

	if (e.button == 2)
	{
		game.RightClick(x, y);
	}
	else
	{
		game.Click(x, y);
	}

	return StopEvent(e);
}


function Game_MouseUp(e)
{
	//game.Click(e.offsetX, e.offsetY);

	return StopEvent(e);
}

// Prevents an event from propogating to the system (eg, blocks right click context menu, ctrl-a select all)
function StopEvent(e)
{
	e.preventDefault();
	return false;
}

function Update(dt)
{
	game.Update(dt);
}


function Render()
{

	renderer.SetFill("black");
	renderer.Fill();

	game.Render();

}


function Step(timestamp)
{
	if (! last_time)
	{
		last_time = timestamp;
	}
	var delta_time = (timestamp - last_time) / 1000.0;
	last_time = timestamp;

	Update(delta_time);

	Render();


	requestAnimationFrame(Step);
}


</script>

</head>

<body onLoad="Init();">

<h1>Ludum Dare 31 : Entire game on one screen</h1>

<div class="left">
By Lasty.
- <a href="https://twitter.com/tristan_lasty">@tristan_lasty</a>
- <a href="https://twitter.com/hashtag/LDJAM?src=hash">#LDJAM</a>
</div>
<div class="right">
Github:  <a href="https://github.com/lasty/ld31_onescreen">https://github.com/lasty/ld31_onescreen</a>
</div>


<div id="loading"> 
<h1>Loading... </h1>
<img src="ProgrammerArt/tiles.png" id="tiles"/>
</div>

<canvas id="canvas"></canvas>

<hr/>

<div id="music">
Music: - 
1: <audio controls loop>
	<source src="Sounds/Music1.mp3" type="audio/mpeg">
</audio>
2: <audio controls loop>
	<source src="Sounds/Music2.mp3" type="audio/mpeg">
</audio>
</div>

<div id="instructions">
<h2>Instructions:</h2>
<li>WASD: Move</li>
<li>Press Reload to restart</li>
<li>Left Click: Shoot things, but no damage yet</li>
<li>Right Click: Shoot particles!</li>
</div>


<br/>
Notes:
<li> May take a while to load first time around.</li>
<li> May not work properly on Internet Explorer.  Use Chrome or Firefox if you have problems. </li>

</body>

</html>
